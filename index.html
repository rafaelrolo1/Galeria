
<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <title>Galeria de Bonsais</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1 { color: darkgreen; }
    select { margin: 10px; padding: 5px; }
    #log { margin-top: 20px; color: red; white-space: pre-wrap; }
    .galeria { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
    .galeria div { text-align: center; }
    .galeria img { width: 200px; height: auto; border-radius: 10px; cursor: pointer; }
    select.auto-selected { background-color: #d1fadf; border-color: green; }
    .fullscreen-img {
      position: fixed; top: 0; left: 0;
      width: 100vw; height: 100vh;
      object-fit: contain;
      background-color: rgba(0, 0, 0, 0.95);
      z-index: 1000;
      display: none;
      cursor: zoom-out;
    }
    .dark {
      background-color: #111;
      color: #eee;
    }
    .dark select, .dark input {
      background-color: #333;
      color: #eee;
    }
    .dark .galeria div {
      background-color: #222;
    }
  </style>
</head>
<body>
<h1>Galeria de Bonsais</h1>
<label>Categoria:
  <select id="categoriaSelect"><option value="">Selecionar categoria</option></select>
</label>
<label>EspÃ©cie:
  <input id="searchEspecie" placeholder="Pesquisar espÃ©cie..." style="margin-left:10px; padding:5px;" type="text"/>
  <select id="especieSelect"><option value="">Selecionar espÃ©cie</option></select>
</label>
<label>Estilo:
  <select id="estiloSelect"><option value="">Todos</option></select>
</label>
<div class="galeria" id="galeria"></div>
<div id="log">logs (v3.01):</div>

<script>
  const apiKey = "AIzaSyAwYMSAn6yrut3thb5c0hrHONWnLTI1OWM";
  const sheetId = "1VszHZn6YCPHGMhNzetQMpozbxxqK6KC1U9SNb_BzK7I";

  const categoriaSelect = document.getElementById("categoriaSelect");
  const especieSelect = document.getElementById("especieSelect");
  const searchInput = document.getElementById("searchEspecie");
  const estiloSelect = document.getElementById("estiloSelect");
  const galeria = document.getElementById("galeria");
  const logEl = document.getElementById("log");

  let especieParaCategoria = {};
  let dadosCategoria = {};
  let todasImagens = [];

  function log(msg) {
    logEl.textContent += "\n" + msg;
    console.log(msg);
  }

  async function fetchSheetRange(sheet, range) {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(sheet)}!${range}?key=${apiKey}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Erro HTTP ${res.status}`);
    const data = await res.json();
    return data.values || [];
  }

  async function carregarCategorias() {
    const categorias = await fetchSheetRange("Categoria", "A1:A100");
    categoriaSelect.innerHTML = '<option value="">Selecionar categoria</option>';
    categorias.forEach(([cat]) => {
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat;
      categoriaSelect.appendChild(opt);
    });
  }

  async function mapearEspecies() {
    const categorias = await fetchSheetRange("Categoria", "A1:A100");
    let todasEspecies = [];
    for (const [cat] of categorias) {
      const especies = await fetchSheetRange(cat, "A1:A100");
      especies.forEach(([esp]) => {
        especieParaCategoria[esp] = cat;
        todasEspecies.push(esp);
      });
    }
    todasEspecies = [...new Set(todasEspecies)].sort();
    especieSelect.innerHTML = '<option value="">Selecionar espÃ©cie</option>';
    todasEspecies.forEach(esp => {
      const opt = document.createElement("option");
      opt.value = esp;
      opt.textContent = esp;
      especieSelect.appendChild(opt);
    });
  }

  async function carregarImagensEspecie(especie) {
    const dados = await fetchSheetRange(especie, "A2:B200");
    return dados.map((row, idx) => ({ estilo: row[0], img: row[1], linha: idx + 2, especie }));
  }

  async function mostrarImagens(lista) {
    galeria.innerHTML = "";
    lista.forEach(({ estilo, img, linha, especie }) => {
      if (!img) return;
      const div = document.createElement("div");
      const im = document.createElement("img");
      const label = document.createElement("div");
      im.src = img;
      im.title = estilo;
      im.onclick = () => {
        fullscreenImage.src = img;
        fullscreenImage.style.display = "block";
      };
      label.textContent = `${especie} - ${estilo || "(sem estilo)"} - #${linha}`;
      div.appendChild(im);
      div.appendChild(label);
      galeria.appendChild(div);
    });
  }

  categoriaSelect.addEventListener("change", async () => {
    const cat = categoriaSelect.value;
    galeria.innerHTML = "";
    especieSelect.value = "";
    if (!cat) return;
    const especies = await fetchSheetRange(cat, "A1:A100");
    const imagens = [];
    for (const [esp] of especies) {
      const imgs = await carregarImagensEspecie(esp);
      imagens.push(...imgs);
    }
    mostrarImagens(imagens);
  });

  document.getElementById("btnDarkMode").onclick = () => {
    document.body.classList.toggle("dark");
  };
  document.getElementById("fullscreenImage").onclick = () => {
    fullscreenImage.style.display = "none";
  };

  document.addEventListener("DOMContentLoaded", async () => {
    await carregarCategorias();
    await mapearEspecies();
    log("JS carregado e DOM pronto.");
  });
</script>
<img class="fullscreen-img" id="fullscreenImage" />
<button id="btnDarkMode" style="position:fixed;top:20px;right:20px;z-index:1001;padding:8px;border:none;border-radius:6px;cursor:pointer;background:#333;color:#fff;">ðŸŒ™</button>
</body>
</html>
