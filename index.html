
<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Galeria de Bonsais</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1 { color: darkgreen; }
    select { margin: 10px; padding: 5px; }
    #log { margin-top: 20px; color: red; white-space: pre-wrap; }
    .galeria { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
    .galeria img { width: 200px; height: auto; border-radius: 10px; cursor: pointer; }
    select.auto-selected { background-color: #d1fadf; border-color: green; }
  </style>
</head>
<body>

  <h1>Galeria de Bonsais</h1>

  <label>Categoria:
    <select id="categoriaSelect">
      <option value="">Selecionar categoria</option>
    </select>
  </label>

  <label>Espécie:
    <input type="text" id="searchEspecie" placeholder="Pesquisar espécie..." style="margin-left:10px; padding:5px;" />
    <select id="especieSelect">
      <option value="">Selecionar espécie</option>
    </select>
  </label>

  <label>Tamanho:
    <select id="tamanhoSelect">
      <option value="">Todos</option>
    </select>
  </label>

  <label>Estilo:
    <select id="estiloSelect">
      <option value="">Todos</option>
    </select>
  </label>

  <div class="galeria" id="galeria"></div>
  <div id="log">Logs:</div>

  <script>
    const apiKey = "AIzaSyAwYMSAn6yrut3thb5c0hrHONWnLTI1OWM";
    const sheetId = "1VszHZn6YCPHGMhNzetQMpozbxxqK6KC1U9SNb_BzK7I";

    const categoriaSelect = document.getElementById("categoriaSelect");
    const especieSelect = document.getElementById("especieSelect");
    const searchInput = document.getElementById("searchEspecie");
    const tamanhoSelect = document.getElementById("tamanhoSelect");
    const estiloSelect = document.getElementById("estiloSelect");
    const galeria = document.getElementById("galeria");

    let filtrosPendentes = { tamanho: "", estilo: "" };
    let especieParaCategoria = {};

    function log(msg) {
      const el = document.getElementById("log");
      el.textContent += "\n" + msg;
      console.log(msg);
    }

    async function fetchSheetRange(sheetName, range) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(sheetName)}!${range}?key=${apiKey}`;
      const response = await fetch(url);
      if (!response.ok) throw new Error("Erro HTTP " + response.status);
      const data = await response.json();
      return data.values || [];
    }

    function setSelectValue(select, value) {
      const exists = [...select.options].some(opt => opt.value === value);
      if (exists) select.value = value;
    }

    async function carregarCategorias() {
      const categorias = await fetchSheetRange("Categoria", "A1:A100");
      categoriaSelect.innerHTML = '<option value="">Selecionar categoria</option>';
      categorias.forEach(([cat]) => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        categoriaSelect.appendChild(opt);
      });
    }

    async function mapearEspeciesCategorias() {
      const categorias = await fetchSheetRange("Categoria", "A1:A100");
      let todas = [];
      for (const [cat] of categorias) {
        try {
          const especies = await fetchSheetRange(cat, "A1:A100");
          especies.forEach(([esp]) => {
            todas.push(esp);
            especieParaCategoria[esp] = cat;
          });
        } catch {}
      }
      todas = [...new Set(todas)].sort();
      especieSelect.innerHTML = '<option value="">Selecionar espécie</option>';
      todas.forEach(esp => {
        const opt = document.createElement("option");
        opt.value = esp;
        opt.textContent = esp;
        especieSelect.appendChild(opt);
      });
    }

    searchInput.addEventListener("input", function () {
      const filtro = this.value.toLowerCase();
      [...especieSelect.options].forEach(opt => {
        opt.style.display = filtro === "" || opt.textContent.toLowerCase().includes(filtro) ? "" : "none";
      });
    });

    categoriaSelect.addEventListener("change", async () => {
      const cat = categoriaSelect.value.trim();
      especieSelect.innerHTML = '<option value="">Selecionar espécie</option>';
      galeria.innerHTML = "";
      if (!cat) return await mapearEspeciesCategorias();
      const especies = await fetchSheetRange(cat, "A1:A100");
      especies.forEach(([esp]) => {
        const opt = document.createElement("option");
        opt.value = esp;
        opt.textContent = esp;
        especieSelect.appendChild(opt);
      });
    });

    especieSelect.addEventListener("change", async () => {
      const esp = especieSelect.value.trim();
      galeria.innerHTML = "";
      tamanhoSelect.innerHTML = '<option value="">Todos</option>';
      estiloSelect.innerHTML = '<option value="">Todos</option>';
      tamanhoSelect.classList.remove("auto-selected");
      estiloSelect.classList.remove("auto-selected");

      filtrosPendentes.tamanho = tamanhoSelect.value;
      filtrosPendentes.estilo = estiloSelect.value;

      if (especieParaCategoria[esp]) categoriaSelect.value = especieParaCategoria[esp];
      if (!esp) return;

      const dados = await fetchSheetRange(esp, "A2:C200");
      const tamanhos = new Set(), estilos = new Set(), imagens = [];
      dados.forEach(row => {
        const [tam, est, img] = row;
        if (tam) tamanhos.add(tam);
        if (est) estilos.add(est);
        if (img) imagens.push({ tamanho: tam, estilo: est, imagem: img });
      });

      if (tamanhos.size === 1) {
        const unico = [...tamanhos][0];
        const opt = new Option(unico, unico);
        tamanhoSelect.appendChild(opt);
        tamanhoSelect.value = unico;
        tamanhoSelect.classList.add("auto-selected");
        filtrosPendentes.tamanho = unico;
      } else {
        tamanhos.forEach(t => tamanhoSelect.appendChild(new Option(t, t)));
      }

      if (estilos.size === 1) {
        const unico = [...estilos][0];
        const opt = new Option(unico, unico);
        estiloSelect.appendChild(opt);
        estiloSelect.value = unico;
        estiloSelect.classList.add("auto-selected");
        filtrosPendentes.estilo = unico;
      } else {
        estilos.forEach(e => estiloSelect.appendChild(new Option(e, e)));
      }

      setSelectValue(tamanhoSelect, filtrosPendentes.tamanho);
      setSelectValue(estiloSelect, filtrosPendentes.estilo);
      aplicarFiltros(imagens);

      tamanhoSelect.onchange = () => aplicarFiltros(imagens);
      estiloSelect.onchange = () => aplicarFiltros(imagens);

      galeria.innerHTML = "";
      imagens.forEach(img => {
        const i = document.createElement("img");
        i.src = img.imagem;
        i.title = `Tamanho: ${img.tamanho}\nEstilo: ${img.estilo}`;
        i.onclick = async () => {
          filtrosPendentes.tamanho = img.tamanho;
          filtrosPendentes.estilo = img.estilo;
          especieSelect.value = esp;
          categoriaSelect.value = especieParaCategoria[esp];
          especieSelect.dispatchEvent(new Event("change"));
        };
        galeria.appendChild(i);
      });
    });

    function aplicarFiltros(lista) {
      const t = tamanhoSelect.value;
      const e = estiloSelect.value;
      galeria.innerHTML = "";
      lista.filter(img =>
        (!t || img.tamanho === t) && (!e || img.estilo === e)
      ).forEach(img => {
        const i = document.createElement("img");
        i.src = img.imagem;
        galeria.appendChild(i);
      });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await carregarCategorias();
      await mapearEspeciesCategorias();
    });
  </script>

</body>
</html>
