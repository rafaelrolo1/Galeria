<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Galeria de Bonsais</title>
  <style>
    body { font-family: sans-serif; padding: 20px; transition: background 0.3s, color 0.3s; }
    h1 { color: darkgreen; }
    label, select, input, button { margin: 5px; padding: 5px; }
    #log { margin-top: 20px; color: red; white-space: pre-wrap; }
    .formulario { margin-top: 40px; padding: 20px; border: 1px solid #ccc; border-radius: 8px; background: #f8f8f8; }
    .dark .formulario { background: #222; border-color: #444; }
    .dark input, .dark select, .dark button { background: #333; color: #eee; border: 1px solid #666; }
    .dark { background: #111; color: #eee; }
    .topo { position: fixed; bottom: 20px; right: 20px; }
    .galeria { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
    .galeria img { max-width: 200px; border-radius: 8px; cursor: pointer; }
    .legenda { text-align: center; font-size: 12px; }
    .fullscreen-img {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      object-fit: contain; background-color: rgba(0,0,0,0.95);
      z-index: 1000; display: none; cursor: zoom-out;
    }
  </style>
</head>
<body>
  <button onclick="document.body.classList.toggle('dark')" style="float:right">üåô</button>
  <h1>Galeria de Bonsais</h1>

  <label>Categoria:
    <select id="filtroCategoria" onchange="atualizarFiltros()"></select>
  </label>
  <label>Esp√©cie:
    <select id="filtroEspecie" onchange="filtrarGaleria()"></select>
  </label>
  <label>Estilo:
    <select id="filtroEstilo" onchange="filtrarGaleria()"></select>
  </label>

  <div class="galeria" id="galeria"></div>
  <div id="log">logs (v3.05):</div>
  <img id="fullscreenImage" class="fullscreen-img" onclick="this.style.display='none'" />

  <div class="formulario">
    <h3>Adicionar novo bonsai</h3>
    <label>Categoria:
      <select id="addCategoria" onchange="filtrarFormularioEspecies()"></select>
    </label>
    <label>Esp√©cie:
      <input id="addEspecie" list="listaEspecies" oninput="filtrarFormularioSubespecies()" placeholder="Escolher ou escrever nova" />
      <datalist id="listaEspecies"></datalist>
    </label>
    <label>Sub-esp√©cie:
      <input id="addSubEspecie" list="listaSubEspecies" placeholder="(opcional)"/>
      <datalist id="listaSubEspecies"></datalist>
    </label>
    <label>Estilo:
      <input id="addEstilo" list="listaEstilos" placeholder="Escolher ou escrever novo"/>
      <datalist id="listaEstilos"></datalist>
    </label>
    <label>Link da imagem:
      <input id="addLink" type="url" placeholder="https://..." style="width:300px"/>
    </label>
    <button onclick="submeterFormulario()">Adicionar √† Galeria</button>
    <div id="respostaAPI" style="margin-top:10px;color:green;"></div>
  </div>

  <button class="topo" onclick="scrollTo(0,0)">üîù</button>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyS-UyNTCMGpCJ08-GuhAsDvCoY8dSQqK5oyiOY8sMITv5We9l8yTEj6F3z16_1VYw1/exec";
    const sheetId = "1VszHZn6YCPHGMhNzetQMpozbxxqK6KC1U9SNb_BzK7I";
    const apiKey = "AIzaSyAwYMSAn6yrut3thb5c0hrHONWnLTI1OWM";

    let dadosOriginais = [];

    async function fetchDados(range) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;
      const r = await fetch(url);
      const j = await r.json();
      return j.values || [];
    }

    async function carregarTudo() {
      const dados = await fetchDados("Bonsai_Gallery!A2:E");
      dadosOriginais = dados;
      preencherDropdowns(dados);
      mostrarGaleria(dados);
      preencherFormulario(dados);
      log("Dados carregados com sucesso.");
    }

    function mostrarGaleria(dados) {
      const div = document.getElementById("galeria");
      div.innerHTML = "";
      dados.forEach(([cat, esp, sub, est, link], idx) => {
        if (!link) return;
        const img = document.createElement("img");
        img.src = link;
        img.alt = esp;
        img.title = `${esp}${sub ? " - " + sub : ""} (${est})`;
        img.onclick = () => {
          const fs = document.getElementById("fullscreenImage");
          fs.src = link;
          fs.style.display = "block";
        };
        const fig = document.createElement("div");
        fig.appendChild(img);
        const leg = document.createElement("div");
        leg.className = "legenda";
        leg.textContent = `${esp}${sub ? " - " + sub : ""}\n#${idx + 2}`;
        fig.appendChild(leg);
        div.appendChild(fig);
      });
    }

    function preencherDropdowns(dados) {
      const categorias = new Set(), especies = new Set(), estilos = new Set();
      dados.forEach(([c, e, , s]) => { categorias.add(c); especies.add(e); estilos.add(s); });
      preencherSelect("filtroCategoria", ["Todas", ...categorias]);
      preencherSelect("filtroEspecie", ["Todas", ...especies]);
      preencherSelect("filtroEstilo", ["Todos", ...estilos]);
    }

    function preencherFormulario(dados) {
      const categorias = new Set(), especies = new Set(), subespecies = new Set(), estilos = new Set();
      dados.forEach(([c, e, sub, s]) => {
        categorias.add(c);
        especies.add(e);
        if (sub) subespecies.add(sub);
        if (s) estilos.add(s);
      });
      preencherSelect("addCategoria", [...categorias]);
      preencherDatalist("listaEspecies", [...especies]);
      preencherDatalist("listaSubEspecies", [...subespecies]);
      preencherDatalist("listaEstilos", [...estilos]);
    }

    function preencherSelect(id, valores) {
      const sel = document.getElementById(id);
      sel.innerHTML = valores.map(v => `<option value="${v}">${v}</option>`).join("");
    }

    function preencherDatalist(id, valores) {
      const d = document.getElementById(id);
      d.innerHTML = valores.map(v => `<option value="${v}"/>`).join("");
    }

    function atualizarFiltros() {
      const cat = document.getElementById("filtroCategoria").value;
      const especies = new Set();
      dadosOriginais.forEach(([c, e]) => { if (c === cat || cat === "Todas") especies.add(e); });
      preencherSelect("filtroEspecie", ["Todas", ...especies]);
      filtrarGaleria();
    }

    function filtrarGaleria() {
      const cat = document.getElementById("filtroCategoria").value;
      const esp = document.getElementById("filtroEspecie").value;
      const est = document.getElementById("filtroEstilo").value;
      const filtrados = dadosOriginais.filter(([c, e, , s]) =>
        (cat === "Todas" || c === cat) &&
        (esp === "Todas" || e === esp) &&
        (est === "Todos" || s === est)
      );
      mostrarGaleria(filtrados);
    }

    function filtrarFormularioEspecies() {
      const cat = document.getElementById("addCategoria").value;
      const especies = new Set();
      dadosOriginais.forEach(([c, e]) => { if (c === cat) especies.add(e); });
      preencherDatalist("listaEspecies", [...especies]);
    }

    function filtrarFormularioSubespecies() {
      const esp = document.getElementById("addEspecie").value;
      const subespecies = new Set();
      dadosOriginais.forEach(([ , e, sub]) => { if (e === esp && sub) subespecies.add(sub); });
      preencherDatalist("listaSubEspecies", [...subespecies]);
    }

    async function submeterFormulario() {
      const categoria = document.getElementById("addCategoria").value;
      const especie = document.getElementById("addEspecie").value;
      const subespecie = document.getElementById("addSubEspecie").value;
      const estilo = document.getElementById("addEstilo").value;
      const link = document.getElementById("addLink").value;

      if (!categoria || !especie || !link) {
        alert("Por favor preencha os campos obrigat√≥rios: Categoria, Esp√©cie e Link.");
        return;
      }

      if (dadosOriginais.some(d => d[4] === link)) {
        alert("Este link j√° existe na galeria.");
        return;
      }

      const dados = { categoria, especie, subespecie, estilo, link };
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(dados),
        headers: { "Content-Type": "application/json" }
      });
      const texto = await res.text();
      document.getElementById("respostaAPI").textContent = texto;
      await carregarTudo();
    }

    function log(t) {
      document.getElementById("log").textContent += `\n${t}`;
    }

    document.addEventListener("DOMContentLoaded", carregarTudo);
  </script>
</body>
</html>
