
<!DOCTYPE html>

<html lang="pt">
<head>
<meta charset="utf-8"/>
<title>Galeria de Bonsais</title>
<style>
    body { font-family: sans-serif; padding: 20px; }
    h1 { color: darkgreen; }
    select { margin: 10px; padding: 5px; }
    #log { margin-top: 20px; color: red; white-space: pre-wrap; }
    .galeria { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
    .galeria div { text-align: center; }
    .galeria img { width: 200px; height: auto; border-radius: 10px; }
    select.auto-selected { background-color: #d1fadf; border-color: green; }
  
.fullscreen-img {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  object-fit: contain;
  background-color: rgba(0, 0, 0, 0.95);
  z-index: 1000;
  display: none;
  cursor: zoom-out;
}

.dark {
  background-color: #111;
  color: #eee;
}
.dark select, .dark input {
  background-color: #333;
  color: #eee;
}
.dark .galeria div {
  background-color: #222;
}
</style>
</head>
<body>
<h1>Galeria de Bonsais</h1>
<label>Categoria:
  <select id="categoriaSelect"><option value="">Selecionar categoria</option></select>
</label>
<label>Esp√©cie:
  <input id="searchEspecie" placeholder="Pesquisar esp√©cie..." style="margin-left:10px; padding:5px;" type="text"/>
<select id="especieSelect"><option value="">Selecionar esp√©cie</option></select>
</label>
<label>Estilo:
  <select id="estiloSelect"><option value="">Todos</option></select>
</label>
<div class="galeria" id="galeria"></div>
<div id="log">logs (v2.06):</div>
<script>
  const apiKey = "AIzaSyAwYMSAn6yrut3thb5c0hrHONWnLTI1OWM";
  const sheetId = "1VszHZn6YCPHGMhNzetQMpozbxxqK6KC1U9SNb_BzK7I";

  const categoriaSelect = document.getElementById("categoriaSelect");
  const especieSelect = document.getElementById("especieSelect");
  const searchInput = document.getElementById("searchEspecie");
  const estiloSelect = document.getElementById("estiloSelect");
  const galeria = document.getElementById("galeria");

  const VERSAO_LOG = "logs (v2.06):";
  let logIniciado = false;
  let filtrosPendentes = { estilo: "" };
  let especieParaCategoria = {};

  function log(msg) {
    const el = document.getElementById("log");
    if (!logIniciado) {
      if (!el.textContent.includes(VERSAO_LOG)) el.textContent = VERSAO_LOG + "\n";
      logIniciado = true;
    }
    el.textContent += "\n" + msg;
    console.log(msg);
  }

  async function fetchSheetRange(sheetName, range) {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(sheetName)}!${range}?key=${apiKey}`;
    const response = await fetch(url);
    if (!response.ok) throw new Error("Erro HTTP " + response.status);
    const data = await response.json();
    return data.values || [];
  }

  function setSelectValue(select, value) {
    const exists = [...select.options].some(opt => opt.value === value);
    if (exists) select.value = value;
  }

  async function carregarCategorias() {
    const categorias = await fetchSheetRange("Categoria", "A1:A100");
    categoriaSelect.innerHTML = '<option value="">Selecionar categoria</option>';
    categorias.forEach(([cat]) => {
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat;
      categoriaSelect.appendChild(opt);
    });
  }

  async function mapearEspeciesCategorias() {
    const categorias = await fetchSheetRange("Categoria", "A1:A100");
    let todas = [];
    for (const [cat] of categorias) {
      try {
        const especies = await fetchSheetRange(cat, "A1:A100");
        especies.forEach(([esp]) => {
          todas.push(esp);
          especieParaCategoria[esp] = cat;
        });
      } catch {}
    }
    todas = [...new Set(todas)].sort();
    especieSelect.innerHTML = '<option value="">Selecionar esp√©cie</option>';
    todas.forEach(esp => {
      const opt = document.createElement("option");
      opt.value = esp;
      opt.textContent = esp;
      especieSelect.appendChild(opt);
    });
  }

  searchInput.addEventListener("input", function () {
    const filtro = this.value.toLowerCase();
    [...especieSelect.options].forEach(opt => {
      opt.style.display = filtro === "" || opt.textContent.toLowerCase().includes(filtro) ? "" : "none";
    });
  });

  
categoriaSelect.addEventListener("change", async () => {
    const cat = categoriaSelect.value.trim();
    especieSelect.innerHTML = '<option value="">Selecionar esp√©cie</option>';
    galeria.innerHTML = "";
    if (!cat) return await mapearEspeciesCategorias();

    const especies = await fetchSheetRange(cat, "A1:A100");
    especies.forEach(([esp]) => {
      const opt = document.createElement("option");
      opt.value = esp;
      opt.textContent = esp;
      especieSelect.appendChild(opt);
    });

    for (const [esp] of especies) {
      if (!esp) continue;
      const dados = await fetchSheetRange(esp, "A2:B200");
      dados.forEach((row, idx) => {
        const est = row[0] || "";
        const img = row[1] || "";
        if (img) {
          const div = document.createElement("div");
          const im = document.createElement("img");
          const label = document.createElement("div");
          const legenda = document.createElement("div");
          im.src = img;
          im.title = "Estilo: " + est;
          label.textContent = "#" + (idx + 2);
          legenda.className = "legenda";
          legenda.textContent = esp + " ‚Ä¢ " + est;
          im.onclick = () => {
            especieSelect.value = esp;
            especieSelect.dispatchEvent(new Event("change"));
            mostrarImagemFullscreen(img);
          };
          div.appendChild(im);
          div.appendChild(label);
          div.appendChild(legenda);
          galeria.appendChild(div);
        }
      });
    }
});

    const cat = categoriaSelect.value.trim();
    especieSelect.innerHTML = '<option value="">Selecionar esp√©cie</option>';
    galeria.innerHTML = "";
    if (!cat) return await mapearEspeciesCategorias();
    const especies = await fetchSheetRange(cat, "A1:A100");
    especies.forEach(([esp]) => {
      const opt = document.createElement("option");
      opt.value = esp;
      opt.textContent = esp;
      especieSelect.appendChild(opt);
    });
  });

  especieSelect.addEventListener("change", async () => {
    const esp = especieSelect.value.trim();
    galeria.innerHTML = "";
    estiloSelect.innerHTML = '<option value="">Todos</option>';
    estiloSelect.classList.remove("auto-selected");
    filtrosPendentes.estilo = estiloSelect.value;

    if (especieParaCategoria[esp]) categoriaSelect.value = especieParaCategoria[esp];
    if (!esp) return;

    const dados = await fetchSheetRange(esp, "A2:B200");
    const estilos = new Set(), imagens = [];
    dados.forEach((row, idx) => {
      const est = row[0] || "";
      const img = row[1] || "";
      if (est) estilos.add(est);
      if (img) imagens.push({ estilo: est, imagem: img, linha: idx + 2 });
    });

    if (estilos.size === 1) {
      const unico = [...estilos][0];
      estiloSelect.appendChild(new Option(unico, unico));
      estiloSelect.value = unico;
      estiloSelect.classList.add("auto-selected");
      filtrosPendentes.estilo = unico;
    } else {
      estilos.forEach(e => estiloSelect.appendChild(new Option(e, e)));
    }

    setSelectValue(estiloSelect, filtrosPendentes.estilo);
    aplicarFiltros(imagens);
    estiloSelect.onchange = () => aplicarFiltros(imagens);
  });

  function aplicarFiltros(lista) {
    const e = estiloSelect.value;
    galeria.innerHTML = "";
    lista.filter(img => (!e || img.estilo === e)).forEach((img, i) => {
      const div = document.createElement("div");
      const im = document.createElement("img");
      const label = document.createElement("div");
      im.src = img.imagem;
      im.title = "Estilo: " + img.estilo;
      label.textContent = "#" + img.linha;
      label.style.fontSize = "14px";
      label.style.color = "#555";
      im.onclick = async () => {
    mostrarImagemFullscreen(img.imagem);
        filtrosPendentes.estilo = img.estilo;
        especieSelect.value = especieSelect.value;
        especieSelect.dispatchEvent(new Event("change"));
      };
      div.appendChild(im);
      div.appendChild(label);
      galeria.appendChild(div);
    });
  }

  document.addEventListener("DOMContentLoaded", async () => {
    await carregarCategorias();
    await mapearEspeciesCategorias();
  });

document.addEventListener("DOMContentLoaded", () => {
  const fullscreen = document.getElementById("fullscreenImage");
  if (fullscreen) {
    fullscreen.addEventListener("click", () => {
      fullscreen.style.display = "none";
      fullscreen.src = "";
    });
  }
});

function mostrarImagemFullscreen(src) {
  const fs = document.getElementById("fullscreenImage");
  if (!fs) return;
  fs.src = src;
  fs.style.display = "block";
}

document.addEventListener("DOMContentLoaded", () => {
  const darkBtn = document.getElementById("btnDarkMode");
  if (darkBtn) {
    darkBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark");
    });
  }

  const btnTop = document.getElementById("btnTop");
  if (btnTop) {
    window.addEventListener("scroll", () => {
      btnTop.style.display = window.scrollY > 300 ? "block" : "none";
    });
    btnTop.addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  }
});
</script>
<img class="fullscreen-img" id="fullscreenImage"/><button id="btnDarkMode" style="position:fixed;top:20px;right:20px;z-index:1001;padding:8px;border:none;border-radius:6px;cursor:pointer;background:#333;color:#fff;">üåô</button><button id="btnTop" style="position:fixed;bottom:20px;right:20px;z-index:1001;padding:8px;border:none;border-radius:6px;cursor:pointer;background:#333;color:#fff;display:none;">‚Üë Topo</button></body>
</html>

