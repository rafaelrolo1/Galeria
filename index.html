<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Galeria de Bonsais</title>
  <style>
    body { font-family: sans-serif; padding: 20px; transition: background 0.3s, color 0.3s; }
    h1 { color: darkgreen; }
    label, select, input, button { margin: 5px; padding: 5px; }
    #log { margin-top: 20px; color: red; white-space: pre-wrap; }
    .formulario { margin-top: 40px; padding: 20px; border: 1px solid #ccc; border-radius: 8px; background: #f8f8f8; }
    .dark .formulario { background: #222; border-color: #444; }
    .dark input, .dark select, .dark button { background: #333; color: #eee; border: 1px solid #666; }
    .dark { background: #111; color: #eee; }
    .topo { position: fixed; bottom: 20px; right: 20px; }
    .galeria { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
    .galeria img { max-width: 200px; border-radius: 8px; cursor: pointer; }
    .legenda { text-align: center; font-size: 12px; }
    .fullscreen-img {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      object-fit: contain; background-color: rgba(0,0,0,0.95);
      z-index: 1000; display: none; cursor: zoom-out;
    }
  </style>
</head>
<body>
  <h1>Galeria de Bonsais</h1>
  <label for="categoria">Categoria:</label>
  <select id="categoria"><option value="">Selecionar categoria</option></select>
  <label for="especie">Espécie:</label>
  <input type="text" id="especie" list="listaEspecies">
  <datalist id="listaEspecies"></datalist>
  <label for="subespecie">Subespécie:</label>
  <input type="text" id="subespecie" list="listaSubespecies">
  <datalist id="listaSubespecies"></datalist>
  <label for="estilo">Estilo:</label>
  <select id="estilo"><option value="Todos">Todos</option></select>
  <div id="galeria" class="galeria"></div>
  <div id="log">logs (v3.06):</div>

  <div class="topo">
    <a href="https://script.google.com/macros/s/AKfycbxA-iKERFmUDlsgpZfGN2mPiQN_254UyPaF7pV62uFkTCfYfI5sCeNjK811wEvGmtBU/exec" target="_blank">
      <button>Adicionar Novo Bonsai</button>
    </a>
  </div>

<script>
const apiKey = "AIzaSyAwYMSAn6yrut3thb5c0hrHONWnLTI1OWM";
const sheetId = "1VszHZn6YCPHGMhNzetQMpozbxxqK6KC1U9SNb_BzK7I";
const range = "Bonsai_Gallery!A2:E500";

const categoriaSelect = document.getElementById("categoriaSelect");
const especieSelect = document.getElementById("especieSelect");
const subespecieSelect = document.getElementById("subespecieSelect");
const estiloSelect = document.getElementById("estiloSelect");
const galeria = document.getElementById("galeria");

let dados = [];

function log(msg) {
  document.getElementById("log").textContent += "\n" + msg;
}

async function fetchDados() {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;
  const res = await fetch(url);
  const json = await res.json();
  dados = json.values.map(r => ({
    categoria: r[0] || "",
    especie: r[1] || "",
    subespecie: r[2] || "",
    estilo: r[3] || "",
    link: r[4] || ""
  }));
  atualizarFiltros();
  atualizarGaleria();
}

function atualizarFiltros() {
  const categorias = new Set(), especies = new Set(), subespecies = new Set(), estilos = new Set();
  const cat = categoriaSelect.value, esp = especieSelect.value;

  dados.forEach(d => {
    if (!cat || d.categoria === cat) categorias.add(d.categoria);
    if (!cat || d.categoria === cat) especies.add(d.especie);
    if ((!cat || d.categoria === cat) && (!esp || d.especie === esp)) subespecies.add(d.subespecie);
    estilos.add(d.estilo);
  });

  atualizarSelect(categoriaSelect, [...categorias], "Todas");
  atualizarSelect(especieSelect, [...especies], "Todas");
  atualizarSelect(subespecieSelect, [...subespecies], "Todas");
  atualizarSelect(estiloSelect, [...estilos], "Todos");
}

function atualizarSelect(select, valores, label) {
  const atual = select.value;
  select.innerHTML = `<option value="">${label}</option>` + valores.sort().map(v =>
    `<option value="${v}">${v}</option>`).join("");
  select.value = atual;
}

function atualizarGaleria() {
  const cat = categoriaSelect.value, esp = especieSelect.value;
  const sub = subespecieSelect.value, est = estiloSelect.value;
  galeria.innerHTML = "";

  dados.forEach((d, i) => {
    if ((cat && d.categoria !== cat) || (esp && d.especie !== esp) ||
        (sub && d.subespecie !== sub) || (est && d.estilo !== est)) return;

    if (d.link) {
      const div = document.createElement("div");
      const img = document.createElement("img");
      const label = document.createElement("div");
      img.src = d.link;
      img.onclick = () => abrirFullscreen(d.link);
      label.textContent = `${d.especie} ${d.subespecie} - ${d.estilo}`;
      div.appendChild(img);
      div.appendChild(label);
      galeria.appendChild(div);
    }
  });
}

function abrirFullscreen(src) {
  const fs = document.getElementById("fullscreenImage");
  fs.src = src;
  fs.style.display = "block";
}

document.getElementById("fullscreenImage").onclick = () => {
  document.getElementById("fullscreenImage").style.display = "none";
};

[categoriaSelect, especieSelect, subespecieSelect, estiloSelect].forEach(sel =>
  sel.addEventListener("change", () => {
    atualizarFiltros();
    atualizarGaleria();
  })
);

document.getElementById("btnDarkMode").onclick = () =>
  document.body.classList.toggle("dark");

fetchDados();
</script>
<button onclick="window.open('inserir_bonsai.html', '_blank')" style="position:fixed;top:20px;right:80px;z-index:1001;padding:8px;border:none;border-radius:6px;cursor:pointer;background:#007BFF;color:#fff;">➕ Adicionar Bonsai</button>
</body>
</html>
