<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Inserir Novo Bonsai</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    h1 { color: darkgreen; }
    label { display: block; margin-top: 10px; }
    input, select, button { width: 100%; padding: 8px; margin-top: 5px; }
    button { background-color: #007BFF; color: white; border: none; cursor: pointer; margin-top: 20px; }
    button:hover { background-color: #0056b3; }
    .mensagem { margin-top: 20px; font-weight: bold; }
    #log { margin-top: 30px; font-size: 0.9em; color: #555; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Adicionar Novo Bonsai</h1>

  <label for="categoria">Categoria:</label>
  <select id="categoria"></select>

  <label for="especie">Espécie:</label>
  <input id="especie" list="listaEspecies" placeholder="Escolha ou escreva uma nova" />
  <datalist id="listaEspecies"></datalist>

  <label for="subespecie">Subespécie:</label>
  <input id="subespecie" list="listaSubespecies" placeholder="Opcional" />
  <datalist id="listaSubespecies"></datalist>

  <label for="estilo">Estilo:</label>
  <input id="estilo" list="listaEstilos" placeholder="Escolha ou escreva novo" />
  <datalist id="listaEstilos"></datalist>

  <label for="link">Link da Imagem:</label>
  <input id="link" type="url" placeholder="https://..." />

  <button onclick="submeter()">Adicionar à Galeria</button>

  <div id="mensagem" class="mensagem"></div>
  <div id="log">logs (v1.01):</div>

  <script>
    const sheetId = "1VszHZn6YCPHGMhNzetQMpozbxxqK6KC1U9SNb_BzK7I";
    const apiKey = "AIzaSyAwYMSAn6yrut3thb5c0hrHONWnLTI1OWM";
    const apiUrl = "https://script.google.com/macros/s/AKfycbyS-UyNTCMGpCJ08-GuhAsDvCoY8dSQqK5oyiOY8sMITv5We9l8yTEj6F3z16_1VYw1/exec";

    let dados = [];

    async function fetchDados(range) {
      const r = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`);
      const j = await r.json();
      return j.values || [];
    }

    async function carregarDropdowns() {
      dados = await fetchDados("Bonsai_Gallery!A2:E");
      const categorias = new Set();
      const especies = new Set();
      const subespecies = new Set();
      const estilos = new Set();

      dados.forEach(([cat, esp, sub, est]) => {
        if (cat) categorias.add(cat);
        if (esp) especies.add(esp);
        if (sub) subespecies.add(sub);
        if (est) estilos.add(est);
      });

      document.getElementById("categoria").innerHTML = [...categorias].map(c => `<option value="${c}">${c}</option>`).join("");
      document.getElementById("listaEspecies").innerHTML = [...especies].map(e => `<option value="${e}"/>`).join("");
      document.getElementById("listaSubespecies").innerHTML = [...subespecies].map(s => `<option value="${s}"/>`).join("");
      document.getElementById("listaEstilos").innerHTML = [...estilos].map(e => `<option value="${e}"/>`).join("");
    }

    async function submeter() {
      const categoria = document.getElementById("categoria").value;
      const especie = document.getElementById("especie").value;
      const subespecie = document.getElementById("subespecie").value;
      const estilo = document.getElementById("estilo").value;
      const link = document.getElementById("link").value;

      const msg = document.getElementById("mensagem");
      const log = document.getElementById("log");

      if (!categoria || !especie || !link) {
        msg.textContent = "Por favor preencha os campos obrigatórios.";
        msg.style.color = "red";
        log.textContent += "\n[Erro] Campos obrigatórios em falta.";
        return;
      }

      if (dados.some(d => d[4] === link)) {
        msg.textContent = "Este link já existe na galeria.";
        msg.style.color = "orange";
        log.textContent += `\n[Erro] Link duplicado: ${link}`;
        return;
      }

      const payload = { categoria, especie, subespecie, estilo, link };

      try {
        const res = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const texto = await res.text();
        msg.textContent = "Adicionado com sucesso!";
        msg.style.color = "green";
        log.textContent += `\n[Sucesso] ${texto}`;
      } catch (err) {
        msg.textContent = "Erro ao enviar os dados.";
        msg.style.color = "red";
        log.textContent += `\n[Erro] ${err}`;
      }
    }

    document.addEventListener("DOMContentLoaded", carregarDropdowns);
  </script>
</body>
</html>
